{% extends "core/base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<a href="#" data-fallback="{% url 'home' %}"
   onclick="goBack(this.dataset.fallback); return false;">â† zurÃ¼ck</a>

<h2>Runde {{ round.date }}</h2>

<a class="btn" href="{% url 'product_list' %}">ğŸ¥© Produkte</a>
<a class="btn" href="{% url 'customer_list' %}">ğŸ‘¤ Kunden</a>
<a class="btn" href="{% url 'quick_order' round.id %}">â• Neue Bestellung</a>

<div class="card">
  <p>Umsatz: <strong>{{ revenue|floatformat:2 }} â‚¬</strong></p>
  <p>Einkauf: <strong>{{ cost|floatformat:2 }} â‚¬</strong></p>

  <p>
    Fahrtkosten:
    <strong>{{ travel|floatformat:2 }} â‚¬</strong>
    <span style="opacity:.75;">
      ({{ round.travel_km|floatformat:1 }} km Ã— {{ km_rate|floatformat:2 }} â‚¬)
    </span>
  </p>

  <hr>

  {% if profit >= 0 %}
    <p>Gewinn: <strong style="color:#6aff6a;">{{ profit|floatformat:2 }} â‚¬</strong></p>
  {% else %}
    <p>Gewinn: <strong style="color:#ff6a6a;">{{ profit|floatformat:2 }} â‚¬</strong></p>
  {% endif %}
</div>

<div class="card">
  <h3>âš¡ Schnellaktionen</h3>

  <form method="post" action="{% url 'round_mark_all_paid' round.id %}" style="margin-bottom:10px;"
        onsubmit="return confirm('Wirklich ALLE als bezahlt markieren?');">
    {% csrf_token %}
    <button class="btn" type="submit">ğŸ’° Alle bezahlt</button>
  </form>

  <form method="post" action="{% url 'round_mark_all_picked' round.id %}"
        onsubmit="return confirm('Wirklich ALLE als abgeholt markieren?');">
    {% csrf_token %}
    <button class="btn" type="submit">ğŸ“¦ Alle abgeholt</button>
  </form>
</div>

<div class="card">
  <h3>ğŸ›’ Einkaufsliste</h3>
  <table>
    <tr><th>Produkt</th><th>Menge</th></tr>
    {% for i in shopping_items %}
      <tr>
        <td>{{ i.product__name }}</td>
        <td>{{ i.total_qty }} {{ i.product__unit }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="2">Keine Bestellungen</td></tr>
    {% endfor %}
  </table>
</div>

<h3>ğŸ“¦ Packliste</h3>
{% for o in orders %}
  <div class="card
    {% if not o.paid and not o.picked_up %}
      border-red
    {% elif not o.paid or not o.picked_up %}
      border-yellow
    {% else %}
      border-green
    {% endif %}
  ">
    <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start;">
      <strong>{{ o.customer.name }}</strong>
      <a class="btn" style="padding:10px; margin-top:0;" href="{% url 'order_edit' o.id %}">âœï¸ Bearbeiten</a>
    </div>

    {% if o.customer.phone %}
      <div style="margin-top:8px; opacity:.9;">
        ğŸ“ {{ o.customer.phone }}
        <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn" style="padding:10px; margin-top:0;" href="tel:{{ o.customer.phone }}">ğŸ“ Anrufen</a>
          <a class="btn" style="padding:10px; margin-top:0;"
             href="https://wa.me/{{ o.customer.phone|cut:' '|cut:'+'|cut:'-'|cut:'('|cut:')' }}">ğŸ’¬ WhatsApp</a>
        </div>
      </div>
    {% endif %}

    <ul>
      {% for item in o.items.all %}
        <li>{{ item.product.name }} â€“ {{ item.quantity }} {{ item.product.unit }}</li>
      {% empty %}
        <li>Keine Positionen</li>
      {% endfor %}
    </ul>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      {% if o.paid %}
        <span style="color:#6aff6a; font-weight:700;">ğŸ’° Bezahlt</span>
      {% else %}
        <a class="btn" href="{% url 'mark_paid' o.id %}">ğŸ’° Bar erhalten</a>
      {% endif %}

      {% if o.picked_up %}
        <span style="color:#6aff6a; font-weight:700;">ğŸ“¦ Abgeholt</span>
      {% else %}
        <a class="btn" href="{% url 'mark_picked' o.id %}">ğŸ“¦ Als abgeholt</a>
      {% endif %}
    </div>
  </div>
{% empty %}
  <div class="card">Keine Bestellungen.</div>
{% endfor %}
{% endblock %}
